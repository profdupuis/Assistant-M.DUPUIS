<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard par Ã©lÃ¨ve</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  <script src="{{ url_for('static', filename='js/keyboard_detector.js') }}"></script>
</head>
<body>
  <div class="dashboard-container">
    <div class="flash-messages">
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages[-1:] %} {# Ne prend que le dernier #}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    </div>
    <div class="dashboard-footer">
      <a href="{{ url_for('dashboard') }}">â† Retour au dashboard principal</a>
      <span>ğŸ”’ ConnectÃ© en tant quâ€™administrateur</span>
      <a href="{{ url_for('admin_logout') }}">Se dÃ©connecter</a>
    </div>


  <h1>ğŸ“ Suivi par classe et par Ã©lÃ¨ve</h1>

  <form method="get" class="filters scenario-action">
    <fieldset>
      <legend>ğŸ“ˆ Analyse dÃ©taillÃ©e par Ã©lÃ¨ve</legend>

      <label for="classe">Classe :</label>
      <select name="classe" id="classe" onchange="this.form.submit()">
        <option value="">Aucune</option>
        {% for cls in all_classes %}
          <option value="{{ cls }}" {% if cls == selected_class %}selected{% endif %}>{{ cls }}</option>
        {% endfor %}
      </select>


      <label for="scenario">ScÃ©nario :</label>
      <select name="scenario" id="scenario" onchange="this.form.submit()">
        <option value="">Aucun</option>
        {% for sc in scenarios %}
          <option value="{{ sc.id }}" {% if sc.id == selected_scenario %}selected{% endif %}>{{ sc.name }}</option>
        {% endfor %}
      </select>

      <label for="student">Ã‰lÃ¨ve :</label>
      <select name="student_id" id="student" onchange="this.form.submit()">
        <option value="">Aucun</option>
        {% for sid in students %}
          <option value="{{ sid }}" {% if sid == student_id %}selected{% endif %}>{{ sid }}</option>
        {% endfor %}
      </select>

    </fieldset>
  </form>


  {% if selected_class and selected_scenario %}
  <form method="post" action="{{ url_for('export_csv') }}" class="scenario-action">
    <fieldset>
      <legend>â¬‡ï¸ Exporter les rÃ©sultats filtrÃ©s</legend>
  
      <input type="hidden" name="classe" value="{{ selected_class }}">
      <input type="hidden" name="scenario" value="{{ selected_scenario }}">
      <input type="hidden" name="student_id" value="{{ student_id or '' }}">
      
      <button type="submit">Exporter CSV</button>
    </fieldset>
  </form>
  {% endif %}

  {% if selected_class and selected_scenario %}
  <form method="post" action="{{ url_for('export_rapport') }}" class="scenario-action">
    <fieldset>
      <legend>ğŸ“„ Exporter le rapport global (classe)</legend>
  
      <input type="hidden" name="classe" value="{{ selected_class }}">
      <input type="hidden" name="scenario" value="{{ selected_scenario }}">
  
      <div class="export-buttons">
        <button type="submit" name="action" value="txt">ğŸ“„ GÃ©nÃ©rer rapport texte</button>
        <button type="submit" name="action" value="tex">ğŸ“„ GÃ©nÃ©rer rapport LaTeX</button>
        {% if is_pdflatex_available() %}
  <button type="submit" name="action" value="pdf">ğŸ“„ GÃ©nÃ©rer rapport PDF</button>
{% else %}
  <p style="color: grey; font-style: italic;">(PDF indisponible sur ce serveur)</p>
{% endif %}
      </div>
    </fieldset>
  </form>
  {% endif %}
  
  


  

  {% if student_id and feedback %}
<div class="feedback-zone">
  <h2>ğŸ—¨ï¸ Feedback donnÃ© Ã  lâ€™Ã©lÃ¨ve</h2>
  <blockquote>{{ feedback.feedback }}</blockquote>
</div>
{% endif %}

{% if stats %}
<h2>ğŸ“‹ Performance par exercice</h2>
<table class="resultats-table">
  <thead>
    <tr>
      <th>Exercice</th>
      <th>% RÃ©ussite</th>
      <th># Tentatives</th>
      <th>Temps moyen (s)</th>
    </tr>
  </thead>
  <tbody>
    {% for row in stats %}
    <tr>
      <td>Exo {{ row.ordinal }}</td>
      <td>{{ "%.0f" | format(row.taux_reussite) }} %</td>
      <td>{{ row.tentatives }}</td>
      <td>{{ "%.1f" | format(row.temps_moyen) }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}


{% if evolution and selected_class %}
    {% if student_id %}
      <h2>ğŸ“ˆ Evolution de l'Ã©lÃ¨ve par fiche</h2>
    {% else %}
      <h2>ğŸ“ˆ Ã‰volution moyenne de la rÃ©ussite de la classe</h2>
    {% endif %}

    <canvas id="graph-evol-scenario"
            data-labels='{{ evolution | map(attribute="scenario") | list | tojson }}'
            data-values='{{ evolution | map(attribute="pourcentage") | list | tojson }}'
            width="600" height="300"></canvas>

    <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard_chart.js') }}"></script>
  {% else %}
    <p><em>Aucune donnÃ©e disponible pour le moment.</em></p>
  {% endif %}

  {% if student_id %}
  <h2>ğŸ“‹ Historique de {{ student_id }}</h2>


  <table>
    <thead>
      <tr>
        <th>Exercice</th><th>SÃ©rie</th><th>Date</th>
        <th>DurÃ©e (s)</th><th>RÃ©ponse</th><th>Correct</th>
      </tr>
    </thead>
    <tbody>
      {% for h in hist %}
      <tr>
        <td>Ex {{ h.ordinal }}</td>   <!-- On affiche Exercice 1, Exercice 2... -->
        <td>{{ h.serie}}</td>          <!-- On affiche le nom du scÃ©nario -->
        <td>{{ h.ended_at.strftime("%d/%m %H:%M") }}</td>
        <td>{{ h.elapsed_s }}</td>
        <td><code>{{ h.given_answer|e }}</code></td>
        <td class="center">
          {% if h.is_correct %}
          âœ…
          {% else %}
          âŒ
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}


  <div class="dashboard-footer">
    <a href="{{ url_for('dashboard') }}">â† Retour au dashboard principal</a>
    <span>ğŸ”’ ConnectÃ© en tant quâ€™administrateur</span>
    <a href="{{ url_for('admin_logout') }}">Se dÃ©connecter</a>
  </div>


</div>
</body>
</html>
