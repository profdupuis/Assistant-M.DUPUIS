<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion RGPD ‚Äì Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <script src="{{ url_for('static', filename='js/keyboard_detector.js') }}"></script>
</head>
<body>
    <div class="dashboard-container">

        <div class="dashboard-footer">
            <a href="{{ url_for('dashboard') }}">‚Üê Retour au dashboard principal</a>
            <span>üîí Connect√© en tant qu‚Äôadministrateur</span>
            <a href="{{ url_for('admin_logout') }}">Se d√©connecter</a>
          </div>


    <h1>üõ°Ô∏è Gestion RGPD des √©l√®ves</h1>

    <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages[-1:] %} {# Ne prend que le dernier #}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      </div>

        {% if last_purge and purge_recent %}
         <div class="info-banner">üßπ Derni√®re purge RGPD effectu√©e le {{ last_purge.strftime('%d/%m/%Y √† %H:%M') }}</div>
        {% else %}
      <div class="warning-banner">‚ö†Ô∏è Aucune purge RGPD effectu√©e r√©cemment (plus de {{ purge_days }} jours).</div>
        {% endif %}
  
        {% if flag_grave_detected %}
        <div class="warning-banner flex-banner">
            <span>üö® Attention : au moins un probl√®me critique (self-harm) a √©t√© d√©tect√© dans les derniers √©changes !</span>
        
            <form action="{{ url_for('export_flags_graves_route') }}" method="post">
                <button type="submit" class="critical-button">‚¨áÔ∏è .csv</button>
            </form>
        </div>
        {% endif %}
    


        
        
    <form method="post" enctype="multipart/form-data" action="{{ url_for('upload_students') }}" class="scenario-action rgpd-form">
        <fieldset>
          <legend>üìÇ Importer un fichier √©l√®ves (.csv)</legend>
          <input type="file" name="fichier" accept=".csv" required>
          <button type="submit">Importer √©l√®ves</button>
        </fieldset>
      </form>

    <form method="get" class="scenario-action rgpd-form">
        <fieldset>
        <legend>üîê G√©rer le consentement et effacer des √©l√®ves</legend>
        <label>Classe :
          <select name="classe">
            <option value="">Aucune</option>
            {% for cls in classes %}
            <option value="{{ cls }}" {% if cls == selected_class %}selected{% endif %}>{{ cls }}</option>
            {% endfor %}
          </select>
        </label>
        <button type="submit">Filtrer</button>
    </fieldset>
      </form>

      <form method="post" action="{{ url_for('archive_and_purge_route') }}" class="scenario-action">
        <fieldset>
            <legend>üì¶ Export WORM + üßπ Purge (>15 jours)</legend>
            <div class="export-buttons">
                <button type="submit">üì¶ Exporter WORM</button>
            </div>
        </fieldset>
    </form>
    

    <!--
    <form method="post" action="{{ url_for('purge_old_logs_route') }}" class="scenario-action">
        <fieldset>
            <legend>üßπ Anonymiser anciens logs</legend>
            <div class="export-buttons">
                <button type="submit">üßπ Purger anciens logs (>15 jours)</button>
            </div>
        </fieldset>
    </form>
    
-->
    <form method="get" action="{{ url_for('download_latest_worm_route') }}" class="scenario-action">
        <fieldset>
            <legend>üìÇ T√©l√©charger archive WORM</legend>
            <div class="export-buttons">
                <button type="submit">‚¨áÔ∏è T√©l√©charger WORM</button>
            </div>
        </fieldset>
    </form>
    
      


     

    {% if selected_class %}
    <table>
        <thead>
            <tr>
                <th>√âl√®ve</th>
                <th>Classe</th>
                <th>Consentement donn√©</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td>{{ student.student_id }}</td>
                <td>{{ student.class }}</td>
                <td>
                    {% if student.rgpd_consent_date %}
                        ‚úÖ ({{ student.rgpd_consent_date.strftime('%d/%m/%Y') }})
                    {% else %}
                        ‚ùå
                    {% endif %}
                </td>
                <td>
                    <form method="POST" action="{{ url_for('delete_student_route', student_id=student.student_id) }}" onsubmit="return confirm('Confirmer la suppression de cet √©l√®ve ?')">
                        <button type="submit">Supprimer</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}


    <h2>üö® Historique des probl√®mes d√©tect√©s</h2>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>√âl√®ve</th>
                <th>Probl√®mes d√©tect√©s</th>
                <th>Prompt concern√©</th>
            </tr>
        </thead>
        <tbody>
            {% for record in flag_history %}
                {% set flags = record.flags %}
                {% set true_flags = [] %}
                {% for key, value in flags.items() %}
                    {% if value %}
                        {% set _ = true_flags.append(key) %}
                    {% endif %}
                {% endfor %}
                
                {% set true_flags_normalized = [] %}
                {% for flag in true_flags %}
                    {% set _ = true_flags_normalized.append(flag.lower()) %}
                {% endfor %}
        
                {% if last_flag_export is none or record.ts > last_flag_export %}
                <tr class="{% if 'self-harm' in true_flags_normalized or 'self-harm/intent' in true_flags_normalized %}urgent{% elif 'violence' in true_flags_normalized or 'hate' in true_flags_normalized %}attention{% endif %}">
                    <td>{{ record.ts.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>{{ record.user_id }}</td>
                    <td>‚ö†Ô∏è {{ true_flags|join(', ') }}</td>
                    <td>{{ record.prompt }}</td>
                </tr>
                {% endif %}
            {% endfor %}
        
            {% if flag_history | selectattr('ts', 'gt', last_flag_export) | list | length == 0 %}
            <tr>
                <td colspan="4">‚úÖ Aucun nouveau probl√®me d√©tect√© depuis le dernier export.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    


    <h2>üìú Historique des exports WORM</h2>
    <table>
        <thead>
            <tr>
                <th>Date d'export</th>
                <th>Nombre de logs export√©s</th>
                <th>Taille du fichier (Ko)</th>
                <th> üìÇ T√©l√©charger</th> <!-- üÜï nouvelle colonne -->
            </tr>
        </thead>
        <tbody>
            {% for record in worm_history %}
            <tr>
                <td>{{ record.export_date.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>{{ record.nb_logs }}</td>
                <td>{{ (record.size_bytes // 1024) }} Ko</td>
                <td><a href="{{ url_for('download_worm_route', filename=record.filename) }}" class="button-download">‚¨áÔ∏è .zip </a></td> <!-- üÜï bouton -->
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    
    <h2>üßπ Historique des purges</h2>
    <table>
        <thead>
            <tr>
                <th>Date de purge</th>
                <th>Logs supprim√©s</th>
                <th>R√©ponses anonymis√©es</th>
            </tr>
        </thead>
        <tbody>
            {% for record in purge_history %}
            <tr>
                <td>{{ record.purge_date.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>{{ record.nb_logs_deleted }}</td>
                <td>{{ record.nb_attempts_anonymized }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    

    <form action="{{ url_for('prepare_audit_route') }}" method="post" class="scenario-action">
        <fieldset>
            <legend>üìã Pr√©parer Audit RGPD</legend>
            <button type="submit" class="audit-button">üìÇ Dossier Complet (.zip)</button>
        </fieldset>
    </form>
    
    <div class="rgpd-banner">
        <h3>üõ°Ô∏è Informations RGPD</h3>
        <ul>
            <li>Identifiants anonymes, aucune donn√©e nominative stock√©e.</li>
            <li>Mod√©ration automatique avant et apr√®s envoi aux IA (OpenAI Moderation API).</li>
            <li>Archivage s√©curis√© des logs (WORM, hash cha√Æn√©).</li>
            <li>Purge automatique des donn√©es apr√®s 15 jours.</li>
            <li>Export complet RGPD possible √† tout moment.</li>
            <li>Droit d'effacement garanti sur simple demande.</li>
            <li>Base de donn√©es h√©berg√©e en Europe (Neon, Francfort).</li>
            <li>Dernier audit RGPD t√©l√©chargeable depuis ce tableau de bord.</li>
        </ul>
    </div>
    
</body>
</div>
</html>
